# ğŸ“ Call Me - å®æ—¶è¯­éŸ³é€šè¯æ’ä»¶ä½¿ç”¨æ‰‹å†Œ

## 1. ç®€ä»‹

`Call Me` æ˜¯ä¸º MaiBot è®¾è®¡çš„é«˜æ€§èƒ½å®æ—¶è¯­éŸ³é€šè¯æ’ä»¶ã€‚å®ƒå…è®¸ç”¨æˆ·é€šè¿‡ WebSocket ä¸æœºå™¨äººè¿›è¡Œå…¨åŒå·¥è¯­éŸ³å¯¹è¯ï¼Œé›†æˆäº† VAD (è¯­éŸ³æ´»åŠ¨æ£€æµ‹)ã€TTS (è¯­éŸ³åˆæˆ) å’Œ LLM (å¤§æ¨¡å‹) èƒ½åŠ›ã€‚

ä¸»è¦ç‰¹æ€§ï¼š

- **ç‹¬ç«‹æœåŠ¡**: è¿è¡Œåœ¨ç‹¬ç«‹çš„ FastAPI è¿›ç¨‹ä¸­ (é»˜è®¤ç«¯å£ 8989)ï¼Œä¸é˜»å¡ä¸»ç¨‹åºã€‚
- **ä½å»¶è¿Ÿ**: ä¼˜åŒ–çš„æµå¼ä¼ è¾“åè®®ã€‚
- **å¯è§†åŒ–ç®¡ç†**: æä¾› REST API ç®¡ç†ç«‹ç»˜å’Œèµ„æºã€‚
- **çƒ­æ’æ‹”**: æ”¯æŒé€šè¿‡æŒ‡ä»¤åŠ¨æ€å¯åœæœåŠ¡ã€‚

ç«‹ç»˜å·¥ä½œå°ç™½ç—´ç‰ˆï¼ˆä¸€æ­¥ä¸€æ­¥éƒ¨ç½²ï¼‰ï¼š`plugins/call_me/AVATAR_STUDIO_USER_GUIDE_LITE_CN.md`  
ç«‹ç»˜å·¥ä½œå°è¯¦ç»†ç‰ˆï¼š`plugins/call_me/AVATAR_STUDIO_USER_GUIDE_CN.md`
TTS é…ç½®ä¸éƒ¨ç½²æŒ‡å—ï¼ˆGPT-SoVITSï¼‰ï¼š`plugins/call_me/TTS_USER_GUIDE_CN.md`
ASR é…ç½®ä¸éƒ¨ç½²æŒ‡å—ï¼ˆæ¨è Sherpaï¼‰ï¼š`plugins/call_me/ASR_USER_GUIDE_CN.md`

## 2. å¿«é€Ÿå¼€å§‹

### 2.1 å¯ç”¨æ’ä»¶

1. ç¡®ä¿æ’ä»¶å·²å®‰è£…åœ¨ `plugins/call_me` ç›®å½•ã€‚
2. é‡å¯ MaiBotï¼Œé…ç½®æ–‡ä»¶ `plugins/call_me/config.toml` å°†è‡ªåŠ¨ç”Ÿæˆã€‚
3. æ’ä»¶æœåŠ¡ä¼šè‡ªåŠ¨éš Bot å¯åŠ¨ã€‚

### 2.2 éªŒè¯è¿è¡Œ

åœ¨æµè§ˆå™¨è®¿é—®: `http://127.0.0.1:8989/docs`
å¦‚æœèƒ½çœ‹åˆ° Swagger UI ç•Œé¢ï¼Œè¯´æ˜æœåŠ¡è¿è¡Œæ­£å¸¸ã€‚

### 2.3 å¤–éƒ¨ä¾èµ– (å¿…è¯»)

æœ¬æ’ä»¶ä½œä¸ºåç«¯æœåŠ¡ï¼Œå¿…é¡»é…åˆä»¥ä¸‹å¤–éƒ¨é¡¹ç›®æ‰èƒ½å®Œæ•´å·¥ä½œï¼š

1.  **Frontend (å‰ç«¯å®¢æˆ·ç«¯)**:
    - ä½ éœ€è¦ä¸€ä¸ªå®ç°äº† `CallMe WebSocket Protocol` çš„å‰ç«¯é¡µé¢æˆ– Appã€‚
    - æ¨èä½¿ç”¨å®˜æ–¹é…å¥—çš„å‰ç«¯é¡¹ç›® (React/Vue) æˆ–å‚è€ƒåè®®è‡ªè¡Œå®ç°ã€‚

2.  **TTS æœåŠ¡ (è¯­éŸ³åˆæˆ)**:
    - æ¨è: **GPT-SoVITS** (æä¾›é«˜å“è´¨çš„è§’è‰²è¯­éŸ³å¤åˆ»)ã€‚
    - è¦æ±‚: éœ€è¦éƒ¨ç½² GPT-SoVITS çš„ API æœåŠ¡ï¼Œå¹¶åœ¨æ’ä»¶ä¸­é…ç½® API åœ°å€ã€‚

3.  **ASR æœåŠ¡ (è¯­éŸ³è½¬æ–‡æœ¬)**:
    - æ¨è: **FunASR** (é˜¿é‡Œå¼€æºçš„é«˜ç²¾åº¦è¯­éŸ³è¯†åˆ«) æˆ– **OpenAI Whisper**ã€‚
    - å½“å‰ç‰ˆæœ¬å·²æ”¯æŒ `mock` / `sherpa` / HTTP ASRï¼ˆå¦‚ FunASR/OpenAI é£æ ¼æ¥å£ï¼‰ã€‚

### 2.4 æœ€ä½é…ç½®è¦æ±‚ï¼ˆæŒ‰å½“å‰é»˜è®¤æ–¹æ¡ˆï¼‰

ä»¥ä¸‹æœ€ä½è¦æ±‚åŸºäºå½“å‰é»˜è®¤é“¾è·¯ï¼š

- `TTS = GPT-SoVITS`ï¼ˆ`[tts].type = "sovits"`ï¼‰
- `ASR = Sherpa Zipformer-CTC`ï¼ˆ`[asr].type = "sherpa"`ï¼‰
- æµè§ˆå™¨å‰ç«¯ + æœ¬æ’ä»¶å®æ—¶ WS é€šè¯

#### 2.4.1 æœ‰ GPUï¼ˆæ¨èï¼Œæ»¡è¶³å®æ—¶ä½“éªŒï¼‰

- CPU: `>= 6` ç‰©ç†æ ¸ï¼ˆå»ºè®® `>= 8`ï¼‰
- å†…å­˜: `>= 16 GB`ï¼ˆå»ºè®® `24 GB`ï¼‰
- GPU: NVIDIA æ˜¾å­˜ `>= 6 GB`ï¼ˆå»ºè®® `8 GB`ï¼‰
- ç£ç›˜: å»ºè®®é¢„ç•™ `>= 15 GB`ï¼ˆæ¨¡å‹ + è¿è¡Œç¼“å­˜ + æ—¥å¿—ï¼‰

è¯´æ˜ï¼š

- è¿™æ˜¯â€œå¯ç¨³å®šæ—¥å¸¸ä½¿ç”¨â€çš„æœ€ä½çº¿ã€‚
- è‹¥æƒ³æ›´ä½å»¶è¿Ÿã€æ›´é«˜å¹¶å‘ï¼Œå»ºè®®ç›´æ¥ä¸Š `8C/16T + 32GB + 8~12GB VRAM`ã€‚

#### 2.4.2 æ—  GPUï¼ˆå¯è¿è¡Œï¼Œä¸æ¨èå®æ—¶ä¸»ç”¨ï¼‰

- CPU: `>= 8` ç‰©ç†æ ¸ï¼ˆå»ºè®® `>= 12`ï¼‰
- å†…å­˜: `>= 24 GB`ï¼ˆå»ºè®® `32 GB`ï¼‰
- ç£ç›˜: å»ºè®®é¢„ç•™ `>= 15 GB`

è¯´æ˜ï¼š

- çº¯ CPU æ–¹æ¡ˆé€šå¸¸å¯ä»¥è·‘é€šï¼Œä½†å»¶è¿Ÿä¼šæ˜æ˜¾å‡é«˜ï¼Œå®æ—¶å¯¹è¯ä½“éªŒä¼šä¸‹é™ã€‚
- æ—  GPU åœºæ™¯æ›´å»ºè®®ï¼šæœ¬æœºè·‘ ASRï¼ŒTTS ä½¿ç”¨å¤–éƒ¨æœåŠ¡ï¼Œæˆ–å…ˆç”¨ `tts.type = "mock"` è”è°ƒã€‚

### 2.5 æ‰‹åŠ¨æ§åˆ¶æŒ‡ä»¤

åœ¨ MaiBot èŠå¤©çª—å£å‘é€ä»¥ä¸‹å‘½ä»¤ï¼š

| æŒ‡ä»¤             | è¯´æ˜                     |
| :--------------- | :----------------------- |
| `/callme status` | æŸ¥çœ‹å½“å‰åå°æœåŠ¡è¿è¡ŒçŠ¶æ€ |
| `/callme stop`   | åœæ­¢åå°æœåŠ¡ (é‡Šæ”¾ç«¯å£)  |
| `/callme start`  | å¯åŠ¨åå°æœåŠ¡             |

---

## 3. é…ç½®è¯´æ˜ (`config.toml`)

ä½äº `plugins/call_me/config.toml`ã€‚ä¿®æ”¹åéœ€**é‡å¯ Bot** æˆ–ä½¿ç”¨ `/callme stop` ç„¶å `/callme start` ç”Ÿæ•ˆã€‚

```toml
[plugin]
enabled = true          # æ’ä»¶æ€»å¼€å…³

[server]
host = "127.0.0.1"      # ç›‘å¬åœ°å€ (0.0.0.0 å…è®¸å±€åŸŸç½‘è®¿é—®)
port = 8989             # æœåŠ¡ç«¯å£
cors_origins = ["*"]    # è·¨åŸŸè®¾ç½®ï¼Œå¼€å‘ç¯å¢ƒå»ºè®®ä¿æŒ ["*"]

[vad]
# VAD (è¯­éŸ³æ£€æµ‹) å‚æ•°ï¼Œé€šå¸¸ä¿æŒé»˜è®¤å³å¯
speech_start_ms = 150   # æ£€æµ‹åˆ°äººå£°çš„çµæ•åº¦ (æ¯«ç§’)
speech_end_ms = 800     # åˆ¤å®šè¯´è¯ç»“æŸçš„é™éŸ³æ—¶é•¿ (æ¯«ç§’) - è°ƒå°ååº”å¿«ï¼Œè°ƒå¤§ä¸æ˜“æ‰“æ–­
mode = "webrtc"         # æ£€æµ‹æ¨¡å¼

[audio]
sample_rate = 24000     # è¾“å‡ºéŸ³é¢‘é‡‡æ ·ç‡
channels = 1            # å•å£°é“

[tts]
type = "sovits"         # "sovits" æˆ– "mock"
api_url = "http://127.0.0.1:9880"
voice_id = "default"

[asr]
type = "mock"           # "funasr", "openai", "sherpa" æˆ– "mock"
api_url = "http://127.0.0.1:10095"

[sherpa]
tokens_path = "D:/models/sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20/tokens.txt"
encoder_path = "D:/models/sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20/encoder-epoch-99-avg-1.onnx"
decoder_path = "D:/models/sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20/decoder-epoch-99-avg-1.onnx"
joiner_path = "D:/models/sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20/joiner-epoch-99-avg-1.onnx"
num_threads = 1
provider = "cpu"
```

---

## 4. å¼€å‘è€…æ¥å£ (API)

### 4.1 REST API (èµ„æºç®¡ç†)

å®Œæ•´çš„ API æ–‡æ¡£è¯·æŸ¥é˜… Swagger UI: `http://127.0.0.1:8989/docs`

#### æ ¸å¿ƒç«¯ç‚¹:

- `GET /api/assets`: åˆ—å‡ºæ‰€æœ‰ä¸Šä¼ çš„å›¾ç‰‡èµ„æºã€‚
- `POST /api/assets/upload`: ä¸Šä¼ æ–°å›¾ç‰‡ (multipart/form-data)ã€‚
- `GET /api/assets/{asset_id}/file`: è·å–ä¸Šä¼ èµ„æºæ–‡ä»¶ã€‚
- `GET /api/avatar-map/active`: è·å–å½“å‰æƒ…ç»ªç«‹ç»˜æ˜ å°„ã€‚
- `PUT /api/avatar-map/bind`: ç»‘å®šæƒ…ç»ªä¸ç«‹ç»˜èµ„æºã€‚
- `GET /api/presets/`: è·å–æ‰€æœ‰ç«‹ç»˜é¢„è®¾ã€‚
- `POST /api/presets/`: åˆ›å»ºæ–°çš„ç«‹ç»˜é¢„è®¾ (å®šä¹‰ä¸åŒçŠ¶æ€ä¸‹çš„å›¾ç‰‡æ˜ å°„)ã€‚
- `GET /api/presets/{id}`: è·å–æŒ‡å®šé¢„è®¾è¯¦æƒ…ã€‚

### 4.2 WebSocket åè®® (å®æ—¶é€šè¯)

- **è¿æ¥åœ°å€**: `ws://127.0.0.1:8989/ws/call`
- **æ•°æ®æ ¼å¼**: JSON

#### 4.2.1 æ¡æ‰‹æµç¨‹

1.  **Client å‘é€**: `{"type": "client.hello"}`
2.  **Server å“åº”**: `{"type": "server.hello", "session_id": "..."}`

#### 4.2.2 å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯

- **ä¸Šä¼ éŸ³é¢‘å—**:
  ```json
  {
    "type": "input.audio_chunk",
    "data": {
      "chunk": "<Base64ç¼–ç çš„PCMéŸ³é¢‘æ•°æ®>"
    }
  }
  ```
- **æ–‡æœ¬è¾“å…¥** (å¯é€‰ï¼Œç”¨äºæµ‹è¯•):
  ```json
  {
    "type": "input.text",
    "data": {
      "text": "ä½ å¥½"
    }
  }
  ```
- **ä¸­æ–­ä¿¡å·** (æ‰“æ–­æœºå™¨äººè¯´è¯):
  ```json
  { "type": "control.interrupt" }
  ```

#### 4.2.3 æœåŠ¡å™¨æ¨é€æ¶ˆæ¯

- **çŠ¶æ€æ›´æ–°**:
  ```json
  { "type": "state.update", "state": "listening" }
  // çŠ¶æ€: listening (ç›‘å¬ä¸­), thinking (æ€è€ƒä¸­), speaking (è¯´è¯ä¸­)
  ```
- **TTS éŸ³é¢‘æ•°æ®**:
  ```json
  {
    "type": "tts.audio_chunk",
    "data": {
      "chunk": "<Base64ç¼–ç çš„WAV/PCMæ•°æ®>",
      "sample_rate": 24000
    }
  }
  ```
- **æ–‡æœ¬å­—å¹•**:
  ```json
  {
    "type": "tts.text_stream",
    "data": { "text": "ä½ å¥½ï¼Œæˆ‘æ˜¯" }
  }
  ```

---

## 5. å¸¸è§é—®é¢˜ (Troubleshooting)

### Q1: å¯åŠ¨æ—¶æç¤ºç«¯å£è¢«å ç”¨ï¼Ÿ

- **åŸå› **: å¯èƒ½æœ‰æ—§çš„ Python è¿›ç¨‹æœªå…³é—­ï¼Œæˆ–è€…å…¶ä»–ç¨‹åºå ç”¨äº† 8989 ç«¯å£ã€‚
- **è§£å†³**:
  1. å°è¯•å‘é€ `/callme stop`ã€‚
  2. ä¿®æ”¹ `config.toml` ä¸­çš„ `port` ä¸ºå…¶ä»–å€¼ (å¦‚ 8990)ï¼Œç„¶å `/callme start`ã€‚

### Q2: æµè§ˆå™¨æ— æ³•å½•éŸ³æˆ–è¿æ¥ï¼Ÿ

- **åŸå› **: æµè§ˆå™¨å®‰å…¨ç­–ç•¥è¦æ±‚éº¦å…‹é£æƒé™å¿…é¡»åœ¨ HTTPS æˆ– localhost ç¯å¢ƒä¸‹ä½¿ç”¨ã€‚
- **è§£å†³**: å¦‚æœæ˜¯å±€åŸŸç½‘è®¿é—® (é localhost)ï¼Œè¯·é…ç½® SSL è¯ä¹¦å¯ç”¨ HTTPSï¼Œæˆ–åœ¨ Chrome `chrome://flags` ä¸­å°†ä½ çš„ IP æ·»åŠ åˆ° `Insecure origins treated as secure`ã€‚

### Q3: æœºå™¨äººè¯´è¯æ— é™æ‰“æ–­è‡ªå·±ï¼Ÿ

- **åŸå› **: æ‰¬å£°å™¨çš„å£°éŸ³è¢«éº¦å…‹é£é‡æ–°å½•å…¥ (å›å£°)ã€‚
- **è§£å†³**:
  1. ä½©æˆ´è€³æœºã€‚
  2. ä½¿ç”¨å¸¦æœ‰ç¡¬ä»¶å›å£°æ¶ˆé™¤ (AEC) çš„éº¦å…‹é£è®¾å¤‡ã€‚
  3. è°ƒå¤§ `config.toml` ä¸­çš„ `speech_start_ms` é˜ˆå€¼ã€‚
